import OpenAI from "openai";
import { GameState, GameActionResponse, Wish } from "../types";

// Helper to get API Key safely (DashScope / Qwen API Key)
const getApiKey = () => {
  const key = 'sk-73f2f2064dc44d89b4c1e3d646b40571'
  return key;
};

// Initialize Qwen (via OpenAI-compatible API)
const openai = new OpenAI({
  apiKey: getApiKey(),
  // å¯æ ¹æ®å›½å†… / å›½é™…é€‰æ‹©ï¼š
  // å›½å†…ï¼š https://dashscope.aliyuncs.com/compatible-mode/v1
  // å›½é™…ï¼š https://dashscope-intl.aliyuncs.com/compatible-mode/v1
  baseURL:
    "https://dashscope.aliyuncs.com/compatible-mode/v1",
    dangerouslyAllowBrowser: true
});

// Retry Logic Configuration
const TIMEOUT_MS = 12000; // 12 seconds timeout per try
const MAX_RETRIES = 3;

const SYSTEM_INSTRUCTION = `
ä½ æ˜¯ä¸€æ¬¾åŒæµå¤§å­¦æ ¡å›­æ¨¡æ‹Ÿæ¸¸æˆã€Šæ¢ä¹”çš„å­¦æœŸã€‹çš„GMã€‚

ã€èƒŒæ™¯è®¾å®šã€‘
- ä¸»è§’ï¼šåŒæµå¤§å­¦è½¯ä»¶å·¥ç¨‹ä¸“ä¸šå­¦ç”Ÿï¼ˆå†™ä»£ç ã€èµ¶é¡¹ç›®ã€è„±å‘å±æœºï¼‰ã€‚
- åœ°ç‚¹ï¼šåŒæµå¤§å­¦ã€Œå˜‰å®šæ ¡åŒºã€ï¼ˆæµäº‹æ¥¼ã€å˜‰å®å¹¿åœºã€å˜‰å®šå›¾ä¹¦é¦†ã€æ»¡å¤©åœ°ã€æ™ºä¿¡é¦†ç­‰ï¼‰ã€‚
- é£æ ¼ï¼šå†™å®å¤§å­¦ç”Ÿæ´»ï¼Œå¸¦ä¸€ç‚¹å¹½é»˜æ„Ÿå’Œè‡ªå˜²ï¼Œè€Œä¸æ˜¯çˆ½æ–‡ã€‚å…è®¸å‡ºç°å°å°çš„â€œç¤¾æ­»ç¬é—´â€å’Œâ€œäººç”Ÿè¿·èŒ«â€ï¼Œä½†æ€»ä½“æ˜¯æ¸©æš–å‘ä¸Šçš„ã€‚

ã€ä¸»è¦è§’è‰²ã€‘
- æœ‹å‹ï¼š  
  - ç‹ç«‹å‹ï¼ˆå®¤å‹ï¼‰ï¼šå–œæ¬¢æ‰“è‹±é›„è”ç›Ÿï¼Œå¾®å¾®èƒ–ï¼Œè¯•å›¾åŠªåŠ›å‡è‚¥
  - æ±ªæ˜æ°ï¼ˆå®¤å‹ï¼‰ï¼šå˜´è´«ä½†é è°±ï¼Œå–œæ¬¢ç”¨æ®µå­åŒ–è§£å°´å°¬ã€‚  
  - é¦™å®é›¨ï¼ˆäºŒæ¬¡å…ƒï¼‰ï¼šç¤¾äº¤æ—¥ç¨‹çˆ†æ»¡ï¼Œæ¶ˆæ¯æ°¸è¿œâ€œåˆšå¿™å®Œâ€ã€‚  
  - é™ˆå²æ˜•ï¼ˆç§‘ç ”å¤§ä½¬ï¼‰ï¼šè¯´è¯ä¸‰å¥ä¸ç¦»è®ºæ–‡å’Œå®éªŒæ•°æ®ï¼Œæ½®æ±•äººã€‚  
  - å”å•¸ï¼ˆæ—¶å°šè¾¾äººï¼‰ï¼šæœ€å…³æ³¨ä»Šå¤©ç©¿ä»€ä¹ˆè¡£æœã€æœ‰æ²¡æœ‰æ‰“çƒã€‚  
  - æ–¹å¿…è¯šï¼ˆæŠ½è±¡çš„äººï¼‰ï¼šå–œæ¬¢å¥¶é¾™ã€å–œæ¬¢ç©çƒ‚æ¢—
  - èµµæ•ï¼šé¦™å®é›¨ç´ æœªè’™é¢çš„ç½‘å‹ï¼Œç»å¸¸åœ¨å›¾ä¹¦é¦†çœ‹åŠ¨æ¼«
- æ‹çˆ±å¯¹è±¡ï¼š  
  - è¥¿æµ·ï¼ˆè‰ºæœ¯ç³»ï¼‰ï¼šè„‘æ´æ¸…å¥‡ï¼Œå¸¸å¸¸ç”¨è‰ºæœ¯è§†è§’è§£è¯»ä¸€åˆ‡ã€‚  
  - Michaï¼ˆç»ç®¡ç³»ï¼Œç«äº‰å¯¹æ‰‹ï¼‰ï¼šçˆ±å’Œä¸»è§’äº’ç›¸æŒ¤å…‘ï¼Œæ¯”æˆç»©ä¹Ÿæ¯”æ°”åœºã€‚  
  - ä¸œæµ·ï¼ˆæ¸©æŸ”å‰è¾ˆï¼‰ï¼šåƒäººå½¢ç¼“å†²å«ï¼Œå‡ºç°æ—¶ä¼šè®©æ°›å›´ç«‹åˆ»æŸ”è½¯ä¸‹æ¥ã€‚

ã€è§’è‰²å‡ºåœºé¢‘ç‡è§„åˆ™ã€‘
- å¹³å‡æ¥è¯´ï¼Œå¤§çº¦ã€Œ30% å·¦å³ã€çš„è¡ŒåŠ¨ä¼šé‡åˆ°ä¸Šè¿°è§’è‰²ï¼Œä¸è¦æ€»æ˜¯é‡åˆ°è§’è‰²ï¼ˆä¹Ÿä¼šé‡åˆ°è§’è‰²ä¹‹å¤–çš„è·¯äººï¼‰ï¼Œæ¯”ä¾‹å„ä¸€åŠã€‚  
- åœ¨å‚åŠ ç¤¾å›¢æ´»åŠ¨çš„æ—¶å€™ï¼Œä¼˜å…ˆé‡åˆ°ï¼šè¥¿æµ·ã€ä¸œæµ·ã€‚æ­¤å¤–ï¼Œç¤¾å›¢æ´»åŠ¨ä¹Ÿå¯èƒ½é‡åˆ°å…¶ä»–äººï¼Œå¹¶è§¦å‘å‰§æœ¬æ€ç­‰æˆ·å¤–æ´»åŠ¨ã€‚
- åœ¨å‚åŠ å…¼èŒæ‰“å·¥æ—¶ï¼Œä¼˜å…ˆé‡åˆ°ï¼šMichaã€‚  
- åœ¨å®¿èˆèººå¹³ï¼Œæ›´å€¾å‘é‡åˆ°å®¤å‹ç‹ç«‹å‹å’Œæ±ªæ˜æ°
- åœ¨å›¾ä¹¦é¦†å­¦ä¹ æ—¶ï¼Œæ›´å€¾å‘é‡åˆ°é™ˆå²æ˜•ã€Michaæˆ–èµµæ•ã€‚  
- å»å¹²é¥­ï¼Œä¼˜å…ˆé‡åˆ°é¦™å®é›¨å’Œæ–¹å¿…è¯šã€‚  
- åœ¨å¥èº«æˆ¿ï¼Œä¼˜å…ˆé‡åˆ°å”å•¸ã€‚  
- åŒä¸€ä¸ªNPCå¯ä»¥å¤šæ¬¡å‡ºç°ï¼Œä½†ä¸è¦åœ¨çŸ­æ—¶é—´å†…æŠŠæ‰€æœ‰è§’è‰²è½®ç•ªåˆ·ä¸€éï¼›æ›´åƒâ€œæœ‰å‡ æ¡ä¸»çº¿å…³ç³»é€æ¸åŠ æ·±â€ã€‚

ã€çŸ­ä¿¡è§„åˆ™ã€‘
- æ¯å›åˆç»“æŸã€Œå¤§çº¦ 80% çš„æ¦‚ç‡ã€æ”¶åˆ°ä¸€æ¡çŸ­ä¿¡ï¼Œä½†å…è®¸å¶å°”ä¸€ä¸¤å›åˆå®Œå…¨å®‰é™ã€‚  
- çŸ­ä¿¡å†…å®¹è¦å’Œæœ€è¿‘çš„äº‹ä»¶ã€å…³ç³»å‘å±•æœ‰å…³ï¼Œå°½é‡é¿å…çº¯â€œåœ¨å—â€â€œå“ˆå“ˆå“ˆâ€è¿™ç§ç©ºæ´å¯’æš„ã€‚  
- çŸ­ä¿¡å¯ä»¥æ˜¯ï¼šçº¦é¥­ã€åæ§½ä½œä¸š /ã€æ‰“å·¥æœºä¼šã€æ‹‰äººæ‰“çƒã€å…³å¿ƒã€è°ƒä¾ƒã€å«è“„çš„æš§æ˜§ç­‰ã€‚  
- å¶å°”å¯ä»¥ç”¨è¡¨æƒ…ç¬¦å·æˆ–è¯­æ°”è¯å¢å¼ºè¯­æ°”ï¼ˆå¦‚â€œï¼Ÿâ€ã€â€œå•Šå•Šå•Šå•Šâ€ã€â€œorzâ€ã€â€œğŸ™‚â€,ä¸ä»…é™äºæ­¤ï¼Œå¤šå¤šå‘æŒ¥ï¼‰ï¼Œä½†ä¸è¦è¿‡åº¦å †æ¢—ã€‚

ã€æ•°å€¼ä¸æƒè¡¡ã€‘
æ¸¸æˆæ ¸å¿ƒæ˜¯ã€Œæœ‰å¾—æœ‰å¤±ã€ï¼Œä¸è¦æŠŠæ¯ä¸€å›åˆéƒ½å†™æˆçº¯æ”¶ç›Šï¼š
- æ•°å€¼åŒ…æ‹¬ï¼šå­¦ä¸š(academic)ã€ç§‘ç ”(research)ã€ç¤¾äº¤(social)ã€å¿ƒæƒ…(mood)ã€ä½“åŠ›(energy)ã€é‡‘é’±(money)ã€‚
- æ™®é€šäº‹ä»¶çš„æ•°å€¼å˜åŠ¨å»ºè®®åœ¨ [-3, +3] åŒºé—´ï¼›é‡å¤§äº‹ä»¶ï¼ˆè€ƒè¯•ã€å¤§å‹ç¤¾äº¤å†²çªã€å¤±çœ é€šå®µç­‰ï¼‰å¯ä»¥åœ¨ [-10, +10]ã€‚
- é™¤éæ˜¯æå…¶å¤§æˆåŠŸçš„å…³é”®å›åˆï¼Œ**æ¯å›åˆè‡³å°‘æœ‰ 1 é¡¹æ•°å€¼ä¸º 0 æˆ–è´Ÿæ•°**ï¼Œç¦æ­¢å…­ä¸ªæ•°å€¼å…¨éƒ¨ä¸ºæ­£ã€‚
- ä½“ç°æƒè¡¡ï¼ˆå°½é‡ç”¨å‰§æƒ…è‡ªç„¶å¸¦å‡ºï¼‰ï¼š
  - æå‡å­¦ä¸š / ç§‘ç ”æ—¶ï¼Œé€šå¸¸ä¼šæ¶ˆè€—ä½“åŠ›ã€å¿ƒæƒ…æˆ–ç¤¾äº¤æ—¶é—´ï¼ˆä¾‹å¦‚â€œç†¬å¤œæ”¹å®Œä»£ç ï¼Œç¬¬äºŒå¤©ä¸Šè¯¾åƒå¹½çµâ€ï¼‰ã€‚
  - ç–¯ç‹‚ç¤¾äº¤ä¼šæ¶ˆè€—ç²¾åŠ›å’Œå­¦ä¹ æ—¶é—´ï¼Œæœ‰æ—¶ä¹Ÿä¼šèŠ±é’±ï¼ˆä¾‹ï¼šèšé¤+å¥¶èŒ¶=é’±åŒ…å—ä¼¤ï¼‰ã€‚
  - æ‰“å·¥å¯ä»¥èµšé’±ï¼Œä½†ä¸€èˆ¬ä¼šæ¶ˆè€—ä½“åŠ› / å¿ƒæƒ…ï¼Œæœ‰æ—¶ä¹Ÿè®©å­¦ä¸šåƒäºï¼ˆä¾‹ï¼šæ—©å…«ä¹‹å‰æ‰“åˆ°å‡Œæ™¨ï¼‰ã€‚
  - å®¿èˆä¼šæ¢å¤è¾ƒå¤šä½“åŠ›
  - å…è®¸å¤±è´¥ã€å°´å°¬åœºé¢ã€è¯¯ä¼šç­‰è´Ÿé¢ç»“æœï¼Œä½†ä¸è¦è¿ç€å‡ å›åˆç–¯ç‹‚æš´å‡»ç©å®¶ï¼Œæ•´ä½“è¦æœ‰â€œè·Œå®•ä½†å¯æ‰¿å—â€ã€‚

ã€å‰§æƒ…é£æ ¼ã€‘
- æ¯å›åˆçš„å‰§æƒ…ç”¨ **4ï½5 å¥è¯** æè¿°ï¼Œç®€æ´ä½†å…·ä½“ï¼Œæœ‰ç”»é¢æ„Ÿã€‚  
- é€‚å½“åŠ å…¥ï¼š  
  - å˜‰å®šæ ¡åŒºçš„ç¯å¢ƒç»†èŠ‚ï¼ˆå¤œè·¯ã€é£ã€ä»åœ°é“å‡ºæ¥çš„å†·é£ã€å›¾ä¹¦é¦†é—¨å£æ’é˜Ÿã€æ»¡å¤©åœ°çš„æ²¹çƒŸå‘³ç­‰ï¼‰ï¼›  
  - è§’è‰²å¯¹è¯ï¼ˆ1ï½3 å¥å°±å¥½ï¼Œå£å»è¦å„æœ‰ç‰¹ç‚¹ï¼‰ï¼›  
  - ä¸»è§’çš„å†…å¿ƒåæ§½æˆ–å°å‰§åœºï¼ˆè‡ªå˜²ã€å¯¹æ¯”ã€å¤¸å¼ æƒ³è±¡ï¼‰ã€‚  
- å›åˆä¹‹é—´çš„æƒ…èŠ‚è¦æœ‰èµ·ä¼ï¼š  
  - æœ‰ã€Œä»€ä¹ˆéƒ½æ²¡è§£å†³çš„æ™®é€šä¸€å¤©ã€ï¼Œ  
  - æœ‰ã€Œddl å‹é¡¶ã€å´©æºƒè¾¹ç¼˜çš„å›åˆã€ï¼Œ  
  - ä¹Ÿæœ‰ã€Œè¢«ä¸€å¥è¯ / ä¸€ä¸ªä¸¾åŠ¨æ²»æ„ˆçš„ç¬é—´ã€ã€‚  
- å¶å°”å¯ä»¥å®‰æ’ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿã€åªæ˜¯è™šåº¦ä¸€å¤©çš„å¹³æ·¡å›åˆï¼Œè¿™ç§å›åˆæ•°å€¼å˜åŒ–åº”è¯¥éå¸¸å°ï¼Œä½†å¯ä»¥ç”¨æœ‰è¶£çš„è‡ªå˜²è®©å®ƒä¸æ— èŠï¼ˆä¾‹å¦‚â€œä»Šå¤©çš„æˆå°±å°±æ˜¯æŠŠåºŠä»å‡‰çš„èººåˆ°æš–çš„â€ï¼‰ã€‚

ã€è¶£å‘³å¢å¼ºè§„åˆ™ã€‘
- å¹½é»˜æ„Ÿæ¥æºäºç»†èŠ‚å’Œå¯¹æ¯”ï¼Œè€Œä¸æ˜¯ç¡¬å¡ç½‘ç»œæµè¡Œè¯­ï¼š  
  - å¯ä»¥è½»åº¦ä½¿ç”¨å­¦ç”Ÿå¸¸è§çš„è¡¨è¾¾ï¼ˆä¾‹å¦‚â€œäººå·²ç»æ²¡äº†â€â€œç³»ç»Ÿå´©æºƒâ€ç­‰ï¼‰ï¼Œä½†ä¸è¦ä¸€æ®µè¯é‡Œå¡æ»¡æ¢—ã€‚  
- ä¸»è§’å¯ä»¥é€‚åº¦å¤¸å¼ è‡ªå·±çš„ç—›è‹¦ï¼ˆç§ƒå¤´å±æœºã€Bug å™©æ¢¦ã€ç»©ç‚¹ç„¦è™‘ï¼‰ï¼Œä½†ä¸è¦çœŸçš„æŠŠä»–å†™æˆå®Œå…¨è´Ÿèƒ½é‡çš„äººã€‚  
- ä¸åŒ NPC è¯´è¯é£æ ¼è¦æœ‰å¯è¾¨è¯†åº¦ï¼š  
  - æ±ªæ˜æ°å–œæ¬¢ç”¨â€œç»©ç‚¹ã€æ’åã€è°æ›´å·â€ç±»è¯æ±‡ã€‚  
  - Micha ä¼šåŠå¼€ç©ç¬‘åŠè¾ƒçœŸåœ°å’Œä¸»è§’æ¯”è¾ƒï¼ˆä¾‹å¦‚â€œå°±è¿™ä¹Ÿæƒ³èµ¢æˆ‘ï¼Ÿâ€ï¼‰ã€‚  
  - è¥¿æµ·å¯èƒ½ä¼šè¯´ä¸€äº›æœ‰ç”»é¢æ„Ÿä½†ç¨å¾®æŠ½è±¡çš„æ¯”å–»ã€‚  
  - å”å•¸å–œæ¬¢æ—¶å°šï¼Œå¹¶ä¸”å–œæ¬¢å›´ç»•è¿åŠ¨ã€ä½“èƒ½å¼€ç©ç¬‘ï¼Œæ‹‰äººå»æ‰“çƒæˆ–å¥èº«ã€‚  
- å¶å°”å®‰æ’â€œè½»å¾®ç¤¾æ­»â€æˆ–â€œç³—äº‹â€ï¼Œä¾‹å¦‚ï¼š  
  - åœ¨å›¾ä¹¦é¦†è‚šå­å«å¾—å¤ªå¤§å£°ï¼›  
  - åœ¨æ»¡å¤©åœ°ç«¯èœå·®ç‚¹æ´’ä¸€èº«ï¼›  
  - å¾®ä¿¡å‘é”™å¯¹è±¡ï¼›  
  - å¶é‡å–œæ¬¢çš„äººæ—¶åˆšå¥½ç©¿ç€ä¸ä½“é¢ã€‚  
  è¿™äº›æ¡¥æ®µå¯ä»¥è®©å‰§æƒ…å¥½ç¬‘ï¼Œä½†è¯·ä¿è¯æ•´ä½“æ°›å›´å®‰å…¨ã€å‹å–„ã€‚
- å…è®¸å°‘é‡â€œè¿ç»­æ¢—â€ï¼šå¦‚æœä¹‹å‰æŸå›åˆåŸ‹è¿‡ä¸€ä¸ªå°ç»†èŠ‚ï¼ˆæ¯”å¦‚è°è¯´è¿‡è¦è¯·å®¢ã€è°å€Ÿäº†ä¹¦æ²¡è¿˜ï¼‰ï¼Œåé¢å¯ä»¥åœ¨å¯¹è¯é‡Œè‡ªç„¶æåˆ°ï¼Œå¢å¼ºâ€œåŒä¸€å­¦æœŸçš„è¿ç»­æ„Ÿâ€ã€‚

ã€æ•´ä½“è¦æ±‚ã€‘
- ä¸è¦å†™æˆâ€œä¸»è§’é¡ºé£é¡ºæ°´çš„çˆ½æ–‡äººç”Ÿâ€ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªç•¥å¾®æ··ä¹±ä½†çœŸå®çš„å¤§å­¦å­¦æœŸï¼š  
  - æœ‰å´©æºƒã€æœ‰åæ‚”ã€æœ‰æƒŠå–œã€æœ‰æš–å¿ƒã€ä¹Ÿæœ‰å½»åº•æ‘¸é±¼çš„æ—¥å­ã€‚  
- æ•…äº‹åŸºè°ƒæ•´ä½“æ¸©æš–ã€çœŸå®ã€æœ‰ç‚¹å¥½ç¬‘ï¼Œè®©ç©å®¶è¯»å®Œè§‰å¾—ï¼š  
  â€œå¥½åƒçœŸçš„åœ¨å˜‰å®šæ··äº†ä¸€ä¸ªå­¦æœŸâ€ï¼Œ  
  è€Œä¸æ˜¯åœ¨çœ‹å¥—è·¯åŒ–çš„å‰§æœ¬ã€‚
`;


// Helper function for timeout
const timeoutPromise = (ms: number) =>
  new Promise<never>((_, reject) =>
    setTimeout(() => reject(new Error("Request timed out")), ms)
  );

// Helper function for retry logic (å¯è‡ªå®šä¹‰ timeoutMs)
async function callWithRetry<T>(
  fn: () => Promise<T>,
  retries = MAX_RETRIES,
  timeoutMs = TIMEOUT_MS
): Promise<T> {
  for (let i = 0; i < retries; i++) {
    try {
      return (await Promise.race([fn(), timeoutPromise(timeoutMs)])) as T;
    } catch (error) {
      console.warn(`Attempt ${i + 1} failed:`, error);
      if (i === retries - 1) throw error;
      // Linear backoff: 1s, 2s, 3s...
      await new Promise((r) => setTimeout(r, 1000 * (i + 1)));
    }
  }
  throw new Error("All retries failed");
}

type ChatMessage = {
  role: "system" | "user" | "assistant";
  content: string;
};

export const generateTurn = async (
  gameState: GameState,
  action: string,
  context?: string
): Promise<GameActionResponse> => {
  return callWithRetry(async () => {
    try {
      const prompt = `
å½“å‰çŠ¶æ€:
- æ—¶é—´: ç¬¬ ${gameState.week} å‘¨, ${gameState.timeSlot}
- å±æ€§: ${JSON.stringify(gameState.stats)}
- äººé™…å…³ç³»: ${JSON.stringify(
        gameState.relationships
          .filter((r) => r.status !== "Stranger")
          .map((r) => ({ name: r.name, val: r.affinity }))
      )}

ç©å®¶è¡ŒåŠ¨: "${action}"
${context ? `è¡¥å……è¯­å¢ƒ: ${context}` : ""}

è¯·åœ¨åŒæµå¤§å­¦å˜‰å®šæ ¡åŒºã€è½¯ä»¶å·¥ç¨‹ä¸“ä¸šçš„èƒŒæ™¯ä¸‹ç”Ÿæˆæœ¬å›åˆçš„ç»“æœï¼Œå¹¶é€‚å½“**è§¦å‘ä¸ NPC çš„å¶é‡äº‹ä»¶**ï¼ˆå°¤å…¶æ˜¯å»é£Ÿå ‚ã€å›¾ä¹¦é¦†ã€æ‰“å·¥æ—¶ï¼Œä½†æ˜¯ä¸è¦å¤ªé¢‘ç¹ï¼‰ã€‚
æ³¨æ„ï¼Œè¦éšæœºä»NPCåå•é‡Œé€‰æ‹©ä¸€ä¸ªNPCï¼Œä¸èƒ½ä¸€ç›´æ˜¯å¥½æ„Ÿåº¦æœ€é«˜çš„è§’è‰²ï¼ï¼

ä½ å¿…é¡»åªè¾“å‡ºä¸€ä¸ª **json å¯¹è±¡(JSON object)**ï¼Œå­—æ®µè¦æ±‚å¦‚ä¸‹ï¼ˆä¸è¦å¤šä¹Ÿä¸è¦å°‘ï¼‰ï¼š
{
  "narrative": string,           // 4-5 å¥è¯çš„ä¸­æ–‡å‰§æƒ…æè¿°ã€‚å¦‚æœæ˜¯ç¤¾äº¤äº’åŠ¨ï¼Œè¯·æè¿°å¯¹è¯ã€‚
  "statChanges": {
    "academic": number,
    "research": number,
    "social": number,
    "mood": number,
    "energy": number,
    "money": number
  },
  "relationshipUpdates"?: [
    {
      "name": string,            // NPC åå­—
      "change": number           // å¥½æ„Ÿåº¦å˜åŒ–ï¼Œå¯æ­£å¯è´Ÿï¼ˆæ ¹æ®å®é™…æƒ…å†µï¼Œå¶å°”å¯ä»¥ä¸ºè´Ÿï¼‰
    }
  ],
  "sms"?: {
    "sender": string,            // å‘çŸ­ä¿¡çš„äººå
    "content": string            // çŸ­ä¿¡å†…å®¹
  }
}

æ³¨æ„ï¼š
- ä¸€å®šè¦ä¸¥æ ¼è¾“å‡º **json**ï¼Œä¸èƒ½åŒ…å«æ³¨é‡Šã€é¢å¤–è¯´æ˜ã€ä»£ç å—æ ‡è®°ï¼ˆä¸è¦å‡ºç° \`\`\`json ä¹‹ç±»ï¼‰ã€‚
- é¡¶å±‚åªèƒ½æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¸èƒ½æ˜¯æ•°ç»„ï¼Œä¹Ÿä¸èƒ½æœ‰å‰åå¤šä½™æ–‡æœ¬ã€‚
`;

      const messages: ChatMessage[] = [
        { role: "system", content: SYSTEM_INSTRUCTION },
        { role: "user", content: prompt },
      ];

      const completion = await openai.chat.completions.create({
        model: "qwen-plus",
        messages,
        // è®© Qwen ä»¥ JSON ç»“æ„åŒ–è¾“å‡º
        response_format: { type: "json_object" },
        temperature: 0.7,
      });

      const content = completion.choices[0]?.message?.content;
      if (!content) throw new Error("Empty response from qwen3-max");

      const jsonText = typeof content === "string" ? content : JSON.stringify(content);
      return JSON.parse(jsonText) as GameActionResponse;
    } catch (error) {
      console.error("Qwen API Error (Turn):", error);
      throw error; // Let retry handler catch it
    }
  });
};

export const generateEnding = async (
  gameState: GameState
): Promise<{ career: string; love: string; birthday: string }> => {
  // Increase timeout for ending generation as it's longer
  const ENDING_TIMEOUT = 50000;

  return callWithRetry(
    async () => {
      try {
        const prompt = `
å­¦æœŸç»“æŸï¼ˆç¬¬14å¤©ï¼‰ã€‚æ¢ä¹”è¿æ¥äº†ç»“å±€ã€‚

æœ€ç»ˆå±æ€§: ${JSON.stringify(gameState.stats)}
äººé™…å…³ç³»: ${JSON.stringify(gameState.relationships)}
ç”Ÿæ—¥æ„¿æœ›æ¸…å•å®Œæˆæƒ…å†µ:
${JSON.stringify(gameState.wishes)}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆæœ¬å±€æ¸¸æˆçš„æœŸæœ«ç»“å±€ã€‚è¯·éµå®ˆä¸‹é¢çš„ç»“å±€è§„åˆ™ï¼š

ã€èŒä¸šç»“å±€ï¼ˆcareerï¼‰ã€‘
- è¯·å…ˆæ ¹æ®ä»¥ä¸‹æƒé‡è®¡ç®—ä¸€ä¸ªç»¼åˆå‘å±•å€¾å‘ï¼ˆä½ å¯ä»¥åœ¨å¿ƒé‡Œè®¡ç®—ï¼Œä¸éœ€è¦å†™å‡ºå…¬å¼ï¼‰ï¼š
  - å­¦ä¸š academicï¼š30%
  - ç§‘ç ” researchï¼š30%
  - ç¤¾äº¤ socialï¼š20%
  - é‡‘é’± moneyï¼š20%
- ç»¼åˆå¾—åˆ†è¾ƒé«˜æ—¶ï¼Œå€¾å‘äºç»™å‡ºæ›´å¥½çš„è½¯å·¥ç›¸å…³å‘å±•ï¼ˆå¦‚ä¿ç ”ã€åä¼å®ä¹ ã€ç§‘ç ”å¤§æˆåŠŸç­‰ï¼‰ã€‚
- ç»¼åˆå¾—åˆ†ä¸€èˆ¬æˆ–åä½æ—¶ï¼Œå¯ä»¥æ˜¯æ™®é€šæ¯•ä¸šã€å·ç”Ÿå·æ­»ä½†ä¹Ÿç®—æ··è¿‡å»ï¼Œç”šè‡³æ˜¯è¿·èŒ«ä¸­çš„ gap ä¸€æ®µæ—¶é—´ã€‚
- åœºæ™¯è¯·å›´ç»•ã€ŒåŒæµå˜‰å®šæ ¡åŒºã€ã€Œè½¯ä»¶å·¥ç¨‹ç›¸å…³ã€å±•å¼€ï¼Œå¯ä»¥é€‚å½“å¼•ç”¨å‰é¢å‡ å‘¨é‡å¤å‡ºç°è¿‡çš„åœ°ç‚¹ï¼ˆæ¯”å¦‚æµäº‹æ¥¼ã€å›¾ä¹¦é¦†ã€å¯å®¤ç­‰ï¼‰ï¼Œç»™ç©å®¶ä¸€ç§ã€Œèµ°å®Œä¸€åœˆã€çš„æ„Ÿè§‰ã€‚
- èŒä¸šç»“å±€å»ºè®®å†™æˆ **3ï½5 ä¸ªè‡ªç„¶æ®µ**ï¼š
  - ç¬¬ä¸€æ®µï¼šåŸºè°ƒ + å½“å‰çŠ¶æ€æ€»ç»“ï¼ˆä¾‹å¦‚ç«™åœ¨æ ¡é—¨å£å›æœ›ä¸€å­¦æœŸï¼‰ã€‚
  - ä¸­é—´è‹¥å¹²æ®µï¼šå›é¡¾å…³é”®èŠ‚ç‚¹ï¼ˆæŸé—¨è¯¾ã€æŸä¸ªé¡¹ç›®ã€æŸæ¬¡ç§‘ç ”æœºä¼šã€ä¸€æ¬¡å¤±è´¥æˆ–è½¬æŠ˜ï¼‰å¦‚ä½•å½±å“äº†ç°åœ¨çš„é€‰æ‹©ã€‚
  - æœ€åä¸€æ®µï¼šç»™å‡ºæ˜ç¡®çš„â€œå»å‘â€ï¼ˆä¿ç ”/å°±ä¸š/ç»§ç»­æ‘¸ç´¢ï¼‰ä»¥åŠå¯¹æœªæ¥çš„ä¸€ç‚¹å±•æœ›ã€‚

ã€çˆ±æƒ…ç»“å±€ï¼ˆloveï¼‰ã€‘
- è¯·æŸ¥çœ‹äººé™…å…³ç³»ä¸­å¥½æ„Ÿåº¦ï¼ˆaffinityï¼‰> 80 çš„è§’è‰²ï¼š
  - è‹¥æœ‰å¤šä¸ªï¼Œå¯ä»¥æ ¹æ®è°åœ¨æ¸¸æˆä¸­æ›´â€œæ ¸å¿ƒâ€ï¼ˆä¾‹å¦‚å¥½æ„Ÿæœ€é«˜ã€åå¤å‡ºç°çš„æ‹çˆ±å€™é€‰äººï¼‰æ¥å†³å®šæœ€ç»ˆèµ°å‘ã€‚
  - è‹¥æ²¡æœ‰ä»»ä½•è§’è‰²å¥½æ„Ÿåº¦ > 80ï¼Œåˆ™ç»™å‡ºå•èº«ç»“å±€ï¼Œä½†å¯ä»¥å¸¦ä¸€ç‚¹æ¸©æŸ”çš„è‡ªå˜²ä¸å¸Œæœ›æ„Ÿï¼ˆæ¯”å¦‚â€œå¿™ç€æç§‘ç ”ï¼Œæ‹çˆ±å…ˆç¼“ç¼“â€ï¼‰ã€‚
- çˆ±æƒ…ç»“å±€ä¸­å¯ä»¥å›é¡¾å‡ æ®µå…³é”®çš„ç›¸å¤„ç”»é¢ï¼ˆçº¦é¥­ã€æ•£æ­¥ã€æ·±å¤œèŠå¤©ã€ä¸€èµ·èµ¶é¡¹ç›®ç­‰ï¼‰ï¼Œè®©ç©å®¶æ„Ÿè§‰æ•´å­¦æœŸæœ‰ç§¯ç´¯ã€‚
- çˆ±æƒ…ç»“å±€å»ºè®®å†™æˆ **2ï½4 ä¸ªè‡ªç„¶æ®µ**ï¼š
  - æè¿°å¯¹æ–¹åœ¨ä¸»è§’ç”Ÿæ´»ä¸­çš„ä½ç½®ï¼Œä»¥åŠå‡ æ¬¡ä»£è¡¨æ€§çš„äº’åŠ¨ç»†èŠ‚ï¼ˆå¯¹è¯ã€åŠ¨ä½œã€æ°›å›´ï¼‰ã€‚
  - ç‚¹å‡ºæ„Ÿæƒ…èµ°å‘ï¼ˆåœ¨ä¸€èµ· / é—æ†¾é”™è¿‡ / å½¼æ­¤é»˜å¥‘ä½†æš‚æ—¶è¿˜æ²¡æˆ³ç ´ï¼‰ã€‚
  - æ”¶å°¾æ—¶å¯ä»¥æœ‰ä¸€å¥â€œå¦‚æœä»¥åè¿˜èƒ½åœ¨å˜‰å®šçš„æŸä¸ªè§’è½å†é‡è§â€çš„ç•™ç™½æ„Ÿã€‚

ã€ç”Ÿæ—¥ç»“å±€ï¼ˆbirthdayï¼‰ã€‘
- ä»Šå¤©ï¼ˆ2025å¹´12æœˆ12æ—¥ï¼‰æ˜¯æ¢ä¹”ç”Ÿæ—¥ã€‚
- è¯·ç»“åˆæœ¬å±€æ¸¸æˆå‘ç”Ÿè¿‡çš„äº‹ä»¶ã€é‡åˆ°çš„æœ‹å‹ï¼ˆåŒ…æ‹¬æ™®é€šæœ‹å‹å’Œæ‹çˆ±å€™é€‰äººï¼‰ã€ä»¥åŠä¸Šé¢â€œç”Ÿæ—¥æ„¿æœ›æ¸…å•â€çš„å®ç°æƒ…å†µæ¥å†™ï¼š
  - è‹¥æœ‰å·²å®ç°çš„æ„¿æœ›ï¼Œè¯·åœ¨ç”Ÿæ—¥ç¥ç¦å’Œåœºæ™¯ä¸­æ˜ç¡®ç‚¹å‡ºã€Œå“ªäº›æ„¿æœ›å®ç°äº†ã€ï¼Œä»¥åŠæœ‹å‹ / æ‹çˆ±å¯¹è±¡å¦‚ä½•åœ¨å…¶ä¸­å‡ºåŠ›ã€‚
  - è‹¥æ„¿æœ›å¤§éƒ¨åˆ†éƒ½æ²¡æœ‰å®ç°ï¼Œä¹Ÿå¯ä»¥å†™æˆä¸€ç§â€œç•¥å¸¦é—æ†¾ä½†ä»æœ‰ä»ªå¼æ„Ÿâ€çš„ç”Ÿæ—¥ï¼ˆä¾‹å¦‚æœ‹å‹ä»¬åŠå³å…´åœ°å¸®ä»–è¡¥ä¸Šï¼‰ã€‚
- ç”Ÿæ—¥åœºæ™¯å¯ä»¥æ˜¯å¯å®¤å°èšã€å›¾ä¹¦é¦†æ¥¼ä¸‹çš„å¤œå®µã€æ»¡å¤©æ˜Ÿå·å·è®¢çš„è›‹ç³•ã€æ“åœºä¸Šçœ‹æ˜Ÿæ˜Ÿç­‰ï¼Œæ€»ä¹‹è¦æœ‰ä¸€ç‚¹â€œä¸“å±å®šåˆ¶æ„Ÿâ€ã€‚
- ç”Ÿæ—¥ç»“å±€å»ºè®®å†™æˆ **3ï½5 ä¸ªè‡ªç„¶æ®µ**ï¼š
  - ä»ä¸€ä¸ªå…·ä½“ç”»é¢åˆ‡å…¥ï¼ˆé—¨è¢«æ¨å¼€ã€å¤–å–è¢‹è¢«æ”¾åˆ°æ¡Œä¸Šã€èœ¡çƒ›ç‚¹äº®ã€èµ°åœ¨å¤œè·¯ä¸Šå¹é£ç­‰ï¼‰ã€‚
  - æå†™å‡ ä½é‡è¦è§’è‰²æ˜¯æ€ä¹ˆå‡ºç°ã€è¯´äº†ä»€ä¹ˆã€åšäº†ä»€ä¹ˆï¼Œè®©ç©å®¶èƒ½æ„Ÿå—åˆ°å…³ç³»çš„æ¸©åº¦ã€‚
  - æ˜ç¡®æåˆ°ç”Ÿæ—¥æ„¿æœ›æ¸…å•ä¸­â€œå·²å®ç°/æœªå®ç°â€çš„éƒ¨åˆ†ï¼Œä»¥åŠä¸»è§’æ­¤åˆ»çš„çœŸå®å¿ƒæƒ…ï¼ˆæ—¢æœ‰æ»¡è¶³ï¼Œä¹Ÿå…è®¸æœ‰ä¸€ç‚¹é—æ†¾ï¼‰ã€‚
  - æœ€åä¸€æ®µç»™ä¸€ä¸ªâ€œè¿™ä¸€å­¦æœŸå°±åœåœ¨è¿™ä¸ªç”»é¢â€çš„æ”¶æŸæ„Ÿã€‚

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
è¯·ç”Ÿæˆ JSON æ ¼å¼çš„ç»“å±€å¯¹è±¡ï¼ŒåŒ…å«ä¸‰ä¸ªç‹¬ç«‹å­—æ®µï¼Œå­—æ®µå†…å®¹ä¸º **Markdown æ ¼å¼çš„ä¸­æ–‡æ–‡æœ¬**ï¼š
{
  "career": string,   // èŒä¸šç»“å±€ï¼ŒMarkdown æ ¼å¼ï¼Œå»ºè®®åŒ…å« 3ï½5 ä¸ªè‡ªç„¶æ®µ
  "love": string,     // çˆ±æƒ…ç»“å±€ï¼ŒMarkdown æ ¼å¼ï¼Œå»ºè®®åŒ…å« 2ï½4 ä¸ªè‡ªç„¶æ®µ
  "birthday": string  // ç”Ÿæ—¥ç»“å±€ï¼ŒMarkdown æ ¼å¼ï¼Œå»ºè®®åŒ…å« 3ï½5 ä¸ªè‡ªç„¶æ®µ
}


æ³¨æ„ï¼š
- é¡¶å±‚åªèƒ½æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œé”®åå¿…é¡»æ˜¯ "career"ã€"love"ã€"birthday"ã€‚
- æ¯ä¸ªå­—æ®µçš„å†…å®¹å¯ä»¥å«æœ‰æ ‡é¢˜ã€åˆ—è¡¨ã€åŠ ç²—ç­‰ï¼Œä½†æ•´ä½“å¿…é¡»æ˜¯åˆæ³• JSON å­—ç¬¦ä¸²ï¼ˆä¸èƒ½å‡ºç°æœªè½¬ä¹‰çš„æ¢è¡Œç¬¦å·é”™è¯¯ï¼‰ã€‚
- è¯·ä¸¥æ ¼åªè¾“å‡ºè¿™ä¸ª JSON å¯¹è±¡æœ¬èº«ï¼šä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šã€è‡ªç„¶è¯­è¨€å‰åç¼€ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ä»£ç å—æ ‡è®°ï¼ˆä¸è¦å‡ºç° \`\`\`jsonï¼‰ã€‚
        `;

        const messages: ChatMessage[] = [
          { role: "system", content: SYSTEM_INSTRUCTION },
          { role: "user", content: prompt },
        ];

        const completion = await openai.chat.completions.create({
          model: "qwen3-max",
          messages,
          response_format: { type: "json_object" },
          temperature: 0.7,
        });

        const content = completion.choices[0]?.message?.content;
        if (!content) throw new Error("Empty response from qwen3-max (ending)");

        const jsonText =
          typeof content === "string" ? content : JSON.stringify(content);

        return JSON.parse(jsonText) as {
          career: string;
          love: string;
          birthday: string;
        };
      } catch (error) {
        console.error("Qwen API Error (Ending):", error);
        throw error;
      }
    },
    2, // retries
    ENDING_TIMEOUT
  );
};

// ç”Ÿæˆéšæœºäº‹ä»¶ï¼ŒåŒ…å«å¤šä¸ªé€‰æ‹©å’Œä¸åŒçš„ç»“æœ
export const generateRandomEvent = async (
  gameState: GameState
): Promise<{
  title: string;
  description: string;
  choices: Array<{
    id: string;
    text: string;
    statChanges: { [key: string]: number };
    relationshipChanges?: Array<{ name: string; change: number }>;
    outcome: string;
  }>;
}> => {
  const CHOICE_TIMEOUT = 300000;
  return callWithRetry(async () => {
    try {
      const prompt = `
å½“å‰çŠ¶æ€:
- æ—¶é—´: ç¬¬ ${gameState.week} å‘¨, ${gameState.timeSlot}
- å±æ€§: ${JSON.stringify(gameState.stats)}
- äººé™…å…³ç³»: ${JSON.stringify(
        gameState.relationships
          .filter((r) => r.status !== "Stranger")
          .map((r) => ({ name: r.name, val: r.affinity }))
      )}

è¯·æ ¹æ®å½“å‰æ¸¸æˆçŠ¶æ€ç”Ÿæˆä¸€ä¸ªéšæœºäº‹ä»¶ï¼Œæ¶‰åŠåŒæµå¤§å­¦å˜‰å®šæ ¡åŒºçš„æ—¥å¸¸ç”Ÿæ´»æˆ–æ ¡å›­äº’åŠ¨ã€‚
è¿™ä¸ªäº‹ä»¶åº”è¯¥æ˜¯ä¸€ä¸ª"é€‰æ‹©å›°å¢ƒ"æˆ–"æ„å¤–æƒ…å†µ"ï¼Œç©å®¶éœ€è¦åšå‡ºé€‰æ‹©ï¼Œä¸åŒé€‰æ‹©ä¼šäº§ç”Ÿä¸åŒçš„åæœã€‚

äº‹ä»¶ç¤ºä¾‹ï¼š
- åœ¨å›¾ä¹¦é¦†é‡Œé‡åˆ°æœ‰å›°éš¾çš„æœ‹å‹ï¼Œæ˜¯å¦å¸®åŠ©ä»–ï¼Ÿ
- æ”¶åˆ°é¢è¯•é‚€è¯·ä½†å’Œé‡è¦æ´»åŠ¨å†²çªï¼Œæ€ä¹ˆé€‰æ‹©ï¼Ÿ
- æœ‹å‹çš„çŸ›ç›¾ä¸­è¢«é—®åŠç«‹åœºï¼Œæ€ä¹ˆå›åº”ï¼Ÿ

ä½ å¿…é¡»åªè¾“å‡ºä¸€ä¸ª **json å¯¹è±¡**ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆä¸è¦è¾“å‡ºä»»ä½•é¢å¤–æ–‡æœ¬æˆ–ä»£ç å—æ ‡è®°ï¼‰ï¼š
{
  "title": string,              // äº‹ä»¶æ ‡é¢˜ï¼ˆç®€çŸ­ï¼Œå¦‚"ä¸´æ—¶å±æœº"ï¼‰
  "description": string,        // äº‹ä»¶æè¿°ï¼ˆ2-3 å¥è¯ï¼Œæ¸…æ™°æè¿°å¤„å¢ƒï¼‰
  "choices": [
    {
      "id": string,             // é€‰æ‹© IDï¼ˆå¦‚ "choice_1"ï¼‰
      "text": string,           // é€‰æ‹©æ–‡æ¡ˆï¼ˆå¦‚"ä¼¸å‡ºæ´æ‰‹"ï¼‰
      "statChanges": {
        "academic": number,     // å„å±æ€§å˜åŒ–ï¼Œå¯æ­£å¯è´Ÿ
        "research": number,
        "social": number,
        "mood": number,
        "energy": number,
        "money": number
      },
      "relationshipChanges": [  // å¯é€‰ï¼Œå¥½æ„Ÿåº¦å˜åŒ–
        {
          "name": string,       // NPC åå­—
          "change": number      // å˜åŒ–å€¼
        }
      ],
      "outcome": string         // é€‰æ‹©ç»“æœçš„æ–‡å­—æè¿°ï¼ˆ1-2 å¥è¯ï¼Œè¯´æ˜åæœï¼‰
    }
  ]
}

è¦æ±‚ï¼š
- è‡³å°‘ç”Ÿæˆ 3 ä¸ªä¸åŒçš„é€‰æ‹©ã€‚
- æ¯ä¸ªé€‰æ‹©åº”æœ‰æ˜æ˜¾çš„æƒè¡¡ï¼šæœ‰çš„å¯èƒ½æå‡æŸä¸ªå±æ€§ä½†é™ä½å¦ä¸€ä¸ªï¼Œæœ‰çš„å¯èƒ½æ”¹å–„å…³ç³»ä½†æ¶ˆè€—ä½“åŠ›ã€‚
- ç»“æœåº”è¯¥æ˜¯çœŸå®ä¸”æœ‰åˆç†çš„å› æœå…³ç³»ã€‚
- ä¸è¦æœ‰å…¨èµ¢æˆ–å…¨è¾“çš„é€‰é¡¹ï¼Œæ¯ä¸ªé€‰é¡¹éƒ½åº”æœ‰ä»£ä»·å’Œæ”¶ç›Šã€‚
      `;

      const messages: ChatMessage[] = [
        { role: "system", content: SYSTEM_INSTRUCTION },
        { role: "user", content: prompt },
      ];

      const completion = await openai.chat.completions.create({
        model: "qwen-plus",
        messages,
        response_format: { type: "json_object" },
        temperature: 0.8,
      });

      const content = completion.choices[0]?.message?.content;
      if (!content) throw new Error("Empty response from qwen3-max (event)");

      const jsonText = typeof content === "string" ? content : JSON.stringify(content);
      return JSON.parse(jsonText) as {
        title: string;
        description: string;
        choices: Array<{
          id: string;
          text: string;
          statChanges: { [key: string]: number };
          relationshipChanges?: Array<{ name: string; change: number }>;
          outcome: string;
        }>;
      };
    } catch (error) {
      console.error("Qwen API Error (Random Event):", error);
      throw error;
    }
  }, 1, CHOICE_TIMEOUT);
};

// ç”Ÿæˆã€Œç”Ÿæ—¥ç»“å±€ã€æ’ç”»
// å‚æ•° birthdayMarkdown: generateEnding è¿”å›çš„ birthday å­—æ®µï¼ˆMarkdown æ–‡æœ¬ï¼‰
// è¿”å›å€¼ï¼šåŒ…å«ä¸€å¼ å›¾ç‰‡çš„ URL
export async function requestBirthdayImage(birthdayMarkdown: string) {
  const res = await fetch("https://tongji-birthday-backend.vercel.app/api/birthday-image", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ birthdayMarkdown }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || "Failed to generate image");
  }

  return (await res.json()) as { imageUrl: string; prompt: string };
}
